{% extends "base.html" %}
{% set active_page = "globalStats" %}

{% block title %}
    Global statistics - FP Central
{% endblock %}

{% block content %}
    <h1>{{ _('Global statistics') }}</h1>
    <div>
        {{ _('Lifetime') }}: {{ totalFP }} {{ _('fingerprints') }}
        <br>
        {{ _('Past 90 days') }}: {{ epochFP }} {{ _('fingerprints') }}
   </div>

    <br>
    <div id="daily" style="width:100%; height:500px;"></div>
    <br>
    <div id="lang" style="width:100%; height:500px;"></div>

    <script type="text/javascript">

        //Daily graph
        var dailyFP = {{ dailyFP|safe }};
        var dailyData = [];
        for(var i=0; i<dailyFP.length; i++){
            var d = dailyFP[i]._id;
            dailyData.push([Date.UTC(d.year,d.month-1,d.day),dailyFP[i].count]);
        }

        //Sort data by date
        dailyData.sort(function(a,b){return a[0] - b[0]});

        //Generate cumulative data
        var cumulativeData = [];
        var nbCounter = 0;
        for(var j=0; j<dailyData.length; j++) {
            nbCounter += dailyData[j][1];
            cumulativeData.push([dailyData[j][0], nbCounter]);
        }

        //Language graph
        var lang = {{ lang|safe }};
        var langData = [];
        for(var k=0; k<lang.length; k++){
            langData.push({'name': (lang[k]._id =="Unspecified")? {{ _('Unspecified') | tojson }} : lang[k]._id.substring(0,2), 'y': lang[k].count});
        }

        $(document).ready(function() {
            $('#daily').highcharts({
                chart: {
                    type: 'spline'
                },
                title: {
                    text: {{ _('Number of stored fingerprints') | tojson }}
                },
                xAxis: {
                    type: 'datetime',
                    title: {
                        text: {{ _('Date') | tojson }}
                    }
                },
                yAxis: {
                    title: {
                        text: {{ _('Number of fingerprints') | tojson }}
                    },
                    min: 0,
                    allowDecimals: false
                },
                tooltip: {
                    shared: true
                },

                plotOptions: {
                    spline: {
                        marker: {
                            enabled: true
                        }
                    }
                },
                series: [{
                    name: {{ _('Daily fingerprints') | tojson }},
                    data: dailyData
                },{
                    name: {{ _('Cumulative fingerprints') | tojson }},
                    data: cumulativeData
                }]
            });

            $('#lang').highcharts({
                chart: {
                    plotBackgroundColor: null,
                    plotBorderWidth: null,
                    plotShadow: false,
                    type: 'pie'
                },
                title: {
                    text: {{ _('Language distribution') | tojson }}
                },
                tooltip: {
                    pointFormat: '{series.name}: <b>{point.percentage:.1f}%</b><br>{point.y} '+ {{ _('fingerprints') | tojson }}
                },
                plotOptions: {
                    pie: {
                        allowPointSelect: true,
                        cursor: 'pointer',
                        dataLabels: {
                            enabled: true,
                            format: '<b>{point.name}</b>: {point.percentage:.1f} %',
                            style: {
                                color: (Highcharts.theme && Highcharts.theme.contrastTextColor) || 'black'
                            }
                        }
                    }
                },
                series: [{
                    name: {{ _('Language') | tojson }},
                    colorByPoint: true,
                    data: langData
                }]
            });

        });

    </script>

    <!-- Load the external libraries -->
    <script type="text/javascript" src="{{ url_for('static', filename="external/highcharts/highcharts.js") }}"></script>
    <script type="text/javascript" src="{{ url_for('static', filename="external/highcharts/highcharts-exporting.js") }}"></script>

{% endblock %}
