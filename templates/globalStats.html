{% extends "base.html" %}
{% set active_page = "globalStats" %}

{% block title %}
    Global statistics - FP Central
{% endblock %}

{% block content %}
    <h1>Global statistics</h1>
    <div>
        Lifetime: {{ totalFP }} fingerprints
        <br>
        Past 90 days: {{ epochFP }} fingerprints
   </div>


    <!--
    Graph on the evolution of collected fingerprints (single day + cumulative)
    Graph on the evolution of collected fingerprints per version?
    Pie chart on the distribution of browsers/tor browser version
    Have a button to switch between lifetime and 90 days stats
    Have a pie chart for language
    -->

    <br>
    <div id="daily" style="width:100%; height:500px;"></div>
    <br>
    <div id="lang" style="width:100%; height:500px;"></div>

    <script type="text/javascript">

        //Daily graph
        var dailyFP = {{ dailyFP|safe }};
        var dailyData = [];
        for(var i=0; i<dailyFP.length; i++){
            var d = dailyFP[i]._id;
            dailyData.push([Date.UTC(d.year,d.month-1,d.day),dailyFP[i].count]);
        }

        //Sort data by date
        dailyData.sort(function(a,b){return a[0] - b[0]});

        //Generate cumulative data
        var cumulativeData = [];
        var nbCounter = 0;
        for(var j=0; j<dailyData.length; j++) {
            nbCounter += dailyData[j][1];
            cumulativeData.push([dailyData[j][0], nbCounter]);
        }

        //Language graph
        var lang = {{ lang|safe }};
        var langData = [];
        for(var k=0; k<lang.length; k++){
            langData.push({'name': (lang[k]._id =="Unspecified")? "Unspecified" : lang[k]._id.substring(0,2), 'y': lang[k].count});
        }

        $(document).ready(function() {
            $('#daily').highcharts({
                chart: {
                    type: 'spline'
                },
                title: {
                    text: 'Number of stored fingerprints'
                },
                xAxis: {
                    type: 'datetime',
                    title: {
                        text: 'Date'
                    }
                },
                yAxis: {
                    title: {
                        text: 'Number of fingerprints'
                    },
                    min: 0,
                    allowDecimals: false
                },
                tooltip: {
                    shared: true
                },

                plotOptions: {
                    spline: {
                        marker: {
                            enabled: true
                        }
                    }
                },
                series: [{
                    name: 'Daily fingerprints',
                    data: dailyData
                },{
                    name: 'Cumulative fingerprints',
                    data: cumulativeData
                }]
            });

            $('#lang').highcharts({
                chart: {
                    plotBackgroundColor: null,
                    plotBorderWidth: null,
                    plotShadow: false,
                    type: 'pie'
                },
                title: {
                    text: 'Language distribution'
                },
                tooltip: {
                    pointFormat: '{series.name}: <b>{point.percentage:.1f}%</b><br>{point.y} fingerprints'
                },
                plotOptions: {
                    pie: {
                        allowPointSelect: true,
                        cursor: 'pointer',
                        dataLabels: {
                            enabled: true,
                            format: '<b>{point.name}</b>: {point.percentage:.1f} %',
                            style: {
                                color: (Highcharts.theme && Highcharts.theme.contrastTextColor) || 'black'
                            }
                        }
                    }
                },
                series: [{
                    name: 'Language',
                    colorByPoint: true,
                    data: langData
                }]
            });

        });

    </script>

    <!-- Load the external libraries -->
    <script type="text/javascript" src="{{ url_for('static', filename="js/highcharts.js") }}"></script>
    <script type="text/javascript" src="{{ url_for('static', filename="js/highcharts-exporting.js") }}"></script>

{% endblock %}
